<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Student number: 23083053">

<title>Urban Simulation Report</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="urban_simulation_report_files/libs/clipboard/clipboard.min.js"></script>
<script src="urban_simulation_report_files/libs/quarto-html/quarto.js"></script>
<script src="urban_simulation_report_files/libs/quarto-html/popper.min.js"></script>
<script src="urban_simulation_report_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="urban_simulation_report_files/libs/quarto-html/anchor.min.js"></script>
<link href="urban_simulation_report_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="urban_simulation_report_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="urban_simulation_report_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="urban_simulation_report_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="urban_simulation_report_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="..\urban_simulation_report.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Urban Simulation Report</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Student number: 23083053 </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<section id="part-1-londons-underground-resilience" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="part-1-londons-underground-resilience"><span class="header-section-number">1</span> Part 1: London’s Underground Resilience</h2>
<p>The first part of this report addresses the resilience of the London Underground using network analysis.</p>
<section id="sec-topological" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="sec-topological"><span class="header-section-number">1.1</span> Topological Network</h3>
<p>In this section, the topological network of the London Underground is analysed, without considering the passenger flows. The weight of each edge is the geographic distance of lines between station pairs.</p>
<section id="centrality-measures" class="level4" data-number="1.1.1">
<h4 data-number="1.1.1" class="anchored" data-anchor-id="centrality-measures"><span class="header-section-number">1.1.1</span> Centrality Measures</h4>
<p>Centrality measures are characteristics of nodes indicating their significance in various aspects. In this report, the measures used to identify significant stations are: degree centrality, betweenness centrality, and closeness centrality. The number of nodes within the network is denoted by <span class="math inline">\(n\)</span>, and the number of links between nodes <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> as <span class="math inline">\(A_{ij}\)</span>.</p>
<p><strong>Degree centrality</strong> is the number of links that are connected to each node. The degree centrality <span class="math inline">\(k_i\)</span> for node <span class="math inline">\(i\)</span> is calculated as</p>
<p><span id="eq-degree-centrality"><span class="math display">\[
k_i = \sum_{j} A_{ij}
\tag{1}\]</span></span></p>
<p>In the context of the underground network, the degree corresponds to the number of directions that serves the station. Since our dataset does not double count two lines serving the same two station pairs, this is equivalent to the number of adjacent stations.</p>
<p><a href="#tbl-degree">Table&nbsp;1</a> shows stations with the highest degree centrality. A high degree centrality indicates there are many lines serving the station, quantifying the importance as a transit hub allowing for transfers.</p>
<div id="tbl-degree" class="anchored">
<table class="table">
<caption>Table&nbsp;1: Stations with the highest degree centrality. All stations tied at a degree of 6 are listed.</caption>
<thead>
<tr class="header">
<th style="text-align: right;">Rank</th>
<th style="text-align: left;">Station</th>
<th style="text-align: right;">Degree</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">Stratford</td>
<td style="text-align: right;">9</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: left;">Bank and Monument</td>
<td style="text-align: right;">8</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: left;">Baker Street</td>
<td style="text-align: right;">7</td>
</tr>
<tr class="even">
<td style="text-align: right;">3</td>
<td style="text-align: left;">King’s Cross St.&nbsp;Pancras</td>
<td style="text-align: right;">7</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: left;">Earl’s Court</td>
<td style="text-align: right;">6</td>
</tr>
<tr class="even">
<td style="text-align: right;">5</td>
<td style="text-align: left;">Canning Town</td>
<td style="text-align: right;">6</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: left;">Liverpool Street</td>
<td style="text-align: right;">6</td>
</tr>
<tr class="even">
<td style="text-align: right;">5</td>
<td style="text-align: left;">Green Park</td>
<td style="text-align: right;">6</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: left;">Oxford Circus</td>
<td style="text-align: right;">6</td>
</tr>
<tr class="even">
<td style="text-align: right;">5</td>
<td style="text-align: left;">Waterloo</td>
<td style="text-align: right;">6</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: left;">West Ham</td>
<td style="text-align: right;">6</td>
</tr>
</tbody>
</table>
</div>
<p><strong>Betweenness centrality</strong> of a node is the number of shortest paths that run through the node. The betweenness centrality <span class="math inline">\(x_i\)</span> for node <span class="math inline">\(i\)</span> is calculated as</p>
<p><span id="eq-betweenness-centrality"><span class="math display">\[
x_i = \sum_{s,t} \frac{n^i_{st}}{g_{st}}
\tag{2}\]</span></span></p>
<p>where</p>
<p><span class="math display">\[
n^i_{st} =
\begin{cases}
1 \quad (\text{if node } i \text{ is on geodesic from } s \text{ to }t)\\
0 \quad (\text{otherwise})
\end{cases}
\]</span></p>
<p>and <span class="math inline">\(g_{st}\)</span> is the total number of geodesic paths from <span class="math inline">\(s\)</span> to <span class="math inline">\(t\)</span>. This can be normalised by dividing by <span class="math inline">\((n-1)(n-2)/2\)</span> (combinations between remaining nodes) to obtain a range between 0 and 1. A station with high betweenness centrality is on the shortest path between many origin-destination pairs of stations, therefore many people are expected to pass it, indicating its importance. The stations with the highest betweenness centrality are shown in <a href="#tbl-betweenness">Table&nbsp;2</a>.</p>
<div id="tbl-betweenness" class="anchored">
<table class="table">
<caption>Table&nbsp;2: Stations with the highest betweenness centrality.</caption>
<thead>
<tr class="header">
<th style="text-align: right;">Rank</th>
<th style="text-align: left;">Station</th>
<th style="text-align: right;">Betweenness Centrality</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">Bank and Monument</td>
<td style="text-align: right;">17,625</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: left;">King’s Cross St.&nbsp;Pancras</td>
<td style="text-align: right;">16,716</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: left;">Stratford</td>
<td style="text-align: right;">14,563</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: left;">Baker Street</td>
<td style="text-align: right;">13,180</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: left;">Oxford Circus</td>
<td style="text-align: right;">12,573</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: left;">Euston</td>
<td style="text-align: right;">12,345</td>
</tr>
<tr class="odd">
<td style="text-align: right;">7</td>
<td style="text-align: left;">Earl’s Court</td>
<td style="text-align: right;">11,452</td>
</tr>
<tr class="even">
<td style="text-align: right;">8</td>
<td style="text-align: left;">Shadwell</td>
<td style="text-align: right;">11,127</td>
</tr>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: left;">Waterloo</td>
<td style="text-align: right;">10,425</td>
</tr>
<tr class="even">
<td style="text-align: right;">10</td>
<td style="text-align: left;">South Kensington</td>
<td style="text-align: right;">10,302</td>
</tr>
</tbody>
</table>
</div>
<p><strong>Closeness centrality</strong> is the inverse of the mean geodesic distance from one node to other reachable <span class="math inline">\(n_0\)</span> nodes (<span class="math inline">\(l_i\)</span>) in the same connected component. This value is scaled by the ratio of reachable nodes to account for connectedness, as proposed by <span class="citation" data-cites="wasserman1994">Wasserman and Faust (<a href="#ref-wasserman1994" role="doc-biblioref">1994</a>)</span>. The closeness centrality <span class="math inline">\(C_i\)</span> is calculated as</p>
<p><span id="eq-closeness-centrality"><span class="math display">\[
C_i = \frac{n_0-1}{n-1} \cdot \frac{1}{l_i} = \frac{(n_0-1)^2}{(n-1) \sum_{j} d_{ij}}
\tag{3}\]</span></span></p>
<p>where <span class="math inline">\(d_{ij}\)</span> is the geodesic distance between nodes <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span>.</p>
<p>A high closeness centrality indicates the station is within a short distance from all the other stations. These stations are located within the city centre, as the high-ranked stations clustered in central London shown in <a href="#tbl-closeness">Table&nbsp;3</a>.</p>
<div id="tbl-closeness" class="anchored">
<table class="table">
<caption>Table&nbsp;3: Stations with the highest closeness centrality. Charing Cross is where the ‘distance to London’ is measured from <span class="citation" data-cites="leatherdale2016">(<a href="#ref-leatherdale2016" role="doc-biblioref">Leatherdale, 2016</a>)</span> - supporting that these stations are located in the city centre.</caption>
<thead>
<tr class="header">
<th style="text-align: right;">Rank</th>
<th style="text-align: left;">Station</th>
<th style="text-align: right;">Closeness Centrality [<span class="math inline">\(\times 10^{-5}\)</span>]</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">Holborn</td>
<td style="text-align: right;">7.924</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: left;">King’s Cross St.&nbsp;Pancras</td>
<td style="text-align: right;">7.907</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: left;">Tottenham Court Road</td>
<td style="text-align: right;">7.888</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: left;">Oxford Circus</td>
<td style="text-align: right;">7.873</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: left;">Leicester Square</td>
<td style="text-align: right;">7.835</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: left;">Picadilly Circus</td>
<td style="text-align: right;">7.831</td>
</tr>
<tr class="odd">
<td style="text-align: right;">7</td>
<td style="text-align: left;">Charing Cross</td>
<td style="text-align: right;">7.830</td>
</tr>
<tr class="even">
<td style="text-align: right;">8</td>
<td style="text-align: left;">Chancery Lane</td>
<td style="text-align: right;">7.823</td>
</tr>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: left;">Covent Garden</td>
<td style="text-align: right;">7.806</td>
</tr>
<tr class="even">
<td style="text-align: right;">10</td>
<td style="text-align: left;">Embankment</td>
<td style="text-align: right;">7.799</td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="impact-measures" class="level4" data-number="1.1.2">
<h4 data-number="1.1.2" class="anchored" data-anchor-id="impact-measures"><span class="header-section-number">1.1.2</span> Impact Measures</h4>
<p>For measuring the impact of node removal, we have used the delta centrality measure proposed by <span class="citation" data-cites="latora2007">Latora and Marchiori (<a href="#ref-latora2007" role="doc-biblioref">2007</a>)</span>. This quantifies the change in performance of the network when a node is removed. For a performance measure <span class="math inline">\(P\)</span> of the network <span class="math inline">\(G\)</span>, the delta centrality <span class="math inline">\(C^{\Delta}_i\)</span> of node <span class="math inline">\(i\)</span> is defined as</p>
<p><span class="math display">\[
C^{\Delta}_i = \frac{\Delta P}{P} = \frac{P(G) - P(G')}{P(G)} \quad (G': G \text{ after removing node }i)
\]</span></p>
<p>The performance measures considered are summarised in <a href="#tbl-delta-performance">Table&nbsp;4</a>.</p>
<div id="tbl-delta-performance" class="anchored">
<table class="table">
<caption>Table&nbsp;4: Performance measures considered for delta centrality.</caption>
<colgroup>
<col style="width: 30%">
<col style="width: 70%">
</colgroup>
<thead>
<tr class="header">
<th>Performance Measure <span class="math inline">\(P\)</span></th>
<th>Explanation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Size of Largest Connected Component (LCC)</td>
<td>The size of LCC shows the connectedness of the network. A smaller number indicates many stations are disconnected from the main network, resulting in less connectess.</td>
</tr>
<tr class="even">
<td>Network Efficiency <span class="math inline">\(E(G) = \frac{1}{n(n-1)}\sum_{i \ne j} \frac{1}{d_{ij}}\)</span></td>
<td>Efficiency measure proposed by <span class="citation" data-cites="latora2001">Latora and Marchiori (<a href="#ref-latora2001" role="doc-biblioref">2001</a>)</span>. A high value indicates lower shortest path lengths between nodes. This measure is applicable for disconnected networks as well, unlike the average shortest path length. Since the <code>nx.global_efficiency()</code> function cannot incorporate edge length, a custom function was defined to calculate this value.</td>
</tr>
</tbody>
</table>
</div>
<p>Applications can be found within and beyond transport networks - closures of NYC subway stations after 9/11 <span class="citation" data-cites="wyatt2002 paaswell2012">(<a href="#ref-wyatt2002" role="doc-biblioref">Wyatt, 2002</a>; <a href="#ref-paaswell2012" role="doc-biblioref">Paaswell, 2012</a>)</span> is one example of analysing transport networks. In other contexts, <span class="citation" data-cites="broder2000">Broder <em>et al.</em> (<a href="#ref-broder2000" role="doc-biblioref">2000</a>)</span> analysed the early worldwide web from the size of (strongly) connected components, and <span class="citation" data-cites="achard2007">Achard and Bullmore (<a href="#ref-achard2007" role="doc-biblioref">2007</a>)</span> is an example of applying the network efficiency measure to the human brain. These examples indicate the global applicability of impact measures.</p>
</section>
<section id="node-removal" class="level4" data-number="1.1.3">
<h4 data-number="1.1.3" class="anchored" data-anchor-id="node-removal"><span class="header-section-number">1.1.3</span> Node Removal</h4>
<p>The measures in <a href="#tbl-delta-performance">Table&nbsp;4</a> is used to analyse the impact of node removal. Two strategies shown in <a href="#tbl-removal-strategies">Table&nbsp;5</a> are used to remove 10 nodes from the network. The stations removed are shown in <a href="#tbl-removed-stations">Table&nbsp;6</a>.</p>
<div id="tbl-removal-strategies" class="anchored">
<table class="table">
<caption>Table&nbsp;5: Strategies for removing nodes.</caption>
<colgroup>
<col style="width: 30%">
<col style="width: 70%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Strategy</th>
<th style="text-align: left;">Explanation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Non-sequential Removal</td>
<td style="text-align: left;">Removes nodes in order that appears in the original rank table (<a href="#tbl-degree">Table&nbsp;1</a>, <a href="#tbl-betweenness">Table&nbsp;2</a>, and <a href="#tbl-closeness">Table&nbsp;3</a>).</td>
</tr>
<tr class="even">
<td style="text-align: left;">Sequential Removal</td>
<td style="text-align: left;">Recalculates centrality on the deformed network after each node removal, and determines the next node to remove based on the recalculated centrality.</td>
</tr>
</tbody>
</table>
</div>
<div id="tbl-removed-stations" class="tbl-parent quarto-layout-panel anchored">
<div class="panel-caption table-caption">
<p>Table&nbsp;6: Stations removed for each centrality measure and strategy.</p>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div id="tbl-removed-stations-1" class="quarto-layout-cell quarto-layout-cell-subref anchored" data-ref-parent="tbl-removed-stations" style="flex-basis: 100.0%;justify-content: center;">
<table class="table">
<caption>(a) Degree Centrality</caption>
<thead>
<tr class="header">
<th style="text-align: right;">Rank</th>
<th style="text-align: left;">Non-sequential</th>
<th style="text-align: left;">Sequential</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">Stratford</td>
<td style="text-align: left;">Stratford</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: left;">Bank and Monument</td>
<td style="text-align: left;">Bank and Monument</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: left;">Baker Street</td>
<td style="text-align: left;">King’s Cross St.&nbsp;Pancras</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: left;">King’s Cross St.&nbsp;Pancras</td>
<td style="text-align: left;">Baker Street</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: left;">Earl’s Court</td>
<td style="text-align: left;">Green Park</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: left;">Canning Town</td>
<td style="text-align: left;">Earl’s Court</td>
</tr>
<tr class="odd">
<td style="text-align: right;">7</td>
<td style="text-align: left;">Liverpool Street</td>
<td style="text-align: left;">Canning Town</td>
</tr>
<tr class="even">
<td style="text-align: right;">8</td>
<td style="text-align: left;">Green Park</td>
<td style="text-align: left;">Oxford Circus</td>
</tr>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: left;">Oxford Circus</td>
<td style="text-align: left;">Willesden Junction</td>
</tr>
<tr class="even">
<td style="text-align: right;">10</td>
<td style="text-align: left;">Waterloo</td>
<td style="text-align: left;">Waterloo</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div id="tbl-removed-stations-2" class="quarto-layout-cell quarto-layout-cell-subref anchored" data-ref-parent="tbl-removed-stations" style="flex-basis: 100.0%;justify-content: center;">
<table class="table">
<caption>(b) Betweenness Centrality</caption>
<thead>
<tr class="header">
<th style="text-align: right;">Rank</th>
<th style="text-align: left;">Non-sequential</th>
<th style="text-align: left;">Sequential</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">Bank and Monument</td>
<td style="text-align: left;">Bank and Monument</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: left;">King’s Cross St.&nbsp;Pancras</td>
<td style="text-align: left;">King’s Cross St.&nbsp;Pancras</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: left;">Stratford</td>
<td style="text-align: left;">Canada Water</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: left;">Baker Street</td>
<td style="text-align: left;">West Hampstead</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: left;">Oxford Circus</td>
<td style="text-align: left;">Earl’s Court</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: left;">Euston</td>
<td style="text-align: left;">Oxford Circus</td>
</tr>
<tr class="odd">
<td style="text-align: right;">7</td>
<td style="text-align: left;">Earl’s Court</td>
<td style="text-align: left;">Shepherd’s Bush</td>
</tr>
<tr class="even">
<td style="text-align: right;">8</td>
<td style="text-align: left;">Shadwell</td>
<td style="text-align: left;">Bakes Street</td>
</tr>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: left;">Waterloo</td>
<td style="text-align: left;">Acton Town</td>
</tr>
<tr class="even">
<td style="text-align: right;">10</td>
<td style="text-align: left;">South Kensington</td>
<td style="text-align: left;">Stratford</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div id="tbl-removed-stations-3" class="quarto-layout-cell quarto-layout-cell-subref anchored" data-ref-parent="tbl-removed-stations" style="flex-basis: 100.0%;justify-content: center;">
<table class="table">
<caption>(c) Closeness Centrality</caption>
<thead>
<tr class="header">
<th style="text-align: right;">Rank</th>
<th style="text-align: left;">Non-sequential</th>
<th style="text-align: left;">Sequential</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">Holborn</td>
<td style="text-align: left;">Holborn</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: left;">King’s Cross St.&nbsp;Pancras</td>
<td style="text-align: left;">King’s Cross St.&nbsp;Pancras</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: left;">Tottenham Court Road</td>
<td style="text-align: left;">Embankment</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: left;">Oxford Circus</td>
<td style="text-align: left;">Waterloo</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: left;">Leicester Square</td>
<td style="text-align: left;">London Bridge</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: left;">Picadilly Circus</td>
<td style="text-align: left;">West Hampstead</td>
</tr>
<tr class="odd">
<td style="text-align: right;">7</td>
<td style="text-align: left;">Charing Cross</td>
<td style="text-align: left;">Clapham Junction</td>
</tr>
<tr class="even">
<td style="text-align: right;">8</td>
<td style="text-align: left;">Chancery Lane</td>
<td style="text-align: left;">Mile End</td>
</tr>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: left;">Covent Garden</td>
<td style="text-align: left;">Stratford</td>
</tr>
<tr class="even">
<td style="text-align: right;">10</td>
<td style="text-align: left;">Embankment</td>
<td style="text-align: left;">Notting Hill Gate</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>The change in performance measures caused by the node removal is illustrated in <a href="#fig-node-removal-measures">Figure&nbsp;1</a>, and the geographic locations of removed stations are mapped in <a href="#fig-node-removal-network">Figure&nbsp;2</a>.</p>
<div id="fig-node-removal-measures" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="img/node_removal_measures.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;1: The change in the performance measures as a result of node removal on the London Underground Network.</figcaption>
</figure>
</div>
<div id="fig-node-removal-network" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="img/node_removal_results.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;2: The map of the London Underground Network after each node removal strategy.</figcaption>
</figure>
</div>
<section id="discussions" class="level5 unnumbered">
<h5 class="unnumbered anchored" data-anchor-id="discussions">Discussions</h5>
<p>The sequential removal is more effective to study resilience of the network compared to non-sequential removal. Since the characteristics of the network change upon node removal, the crucial node may also change when re-evaluating the remaining network. By assessing the importance of node at each step, the sequential removal is capable of identifying nodes that gain importance after the initial deformation.</p>
<p>Node removal based on the betweenness centrality has the largest impact on performance. Since a high betweenness centrality indicates many geodesics passing the node, removing this node will force many paths to divert to different routes. Interestingly, the degree centrality has identified the first few stations with larger impact. Further investigation is required to identify whether this is a general trend or specific to the Underground network.</p>
<p>When comparing between impact measures, the efficiency is a better evaluation of the performance. The size of LCC is unable to assess the impact of station removal unless it disconnects nodes from the network, whereas the efficiency can assess the change within a connected network, thus the impact is more sensitively reported. Comparing the observations, the LCC shows little change except when removing hub stations that disconnect branches, where efficiency gives a continuous evaluation of performance.</p>
</section>
</section>
</section>
<section id="sec-weighted" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="sec-weighted"><span class="header-section-number">1.2</span> Flows: Weighted Network</h3>
<p>In this section, a weighted network considering the passenger flows is analysed. Based on the morning peak origin-destination data from <span class="citation" data-cites="transportforlondon2021">Transport for London (<a href="#ref-transportforlondon2021" role="doc-biblioref">2021</a>)</span>, flows have been assigned to the shortest path between nodes considering the length of each edge. The flow is either used to weight origin-destination pairs or used directly as the weight of edges between stations.</p>
<section id="centrality-measures-1" class="level4" data-number="1.2.1">
<h4 data-number="1.2.1" class="anchored" data-anchor-id="centrality-measures-1"><span class="header-section-number">1.2.1</span> Centrality Measures</h4>
<p>First, we have considered whether centrality measures in <a href="#sec-topological">Section&nbsp;1.1</a> need adjustments to be applied to the weighted network. The adjustments made for the weighted measures are summarised in <a href="#tbl-weighted-centrality-measures">Table&nbsp;7</a>.</p>
<div id="tbl-weighted-centrality-measures" class="anchored">
<table class="table">
<caption>Table&nbsp;7: Adjustments made for each centrality measure on the weighted network.</caption>
<colgroup>
<col style="width: 20%">
<col style="width: 25%">
<col style="width: 55%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Centrality measure</th>
<th style="text-align: left;">Weighted measure</th>
<th style="text-align: left;">Explanation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Degree Centrality</td>
<td style="text-align: left;">Strength <span class="math inline">\(s_i = \sum_j A_{ij}w_{ij}\)</span></td>
<td style="text-align: left;"><span class="math inline">\(w_{ij}\)</span> is the flow on link between nodes <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span>. A measure discussed as the strength <span class="math inline">\(s_i\)</span> in <span class="citation" data-cites="lee2008">Lee <em>et al.</em> (<a href="#ref-lee2008" role="doc-biblioref">2008</a>)</span>, quantifying the amount of flow on edges connected to the node. This measure is highly related to the betweenness centrality, since they both address the flows involving the node. The unweighted degree centrality is a valid measure in a weighted network as well.</td>
</tr>
<tr class="even">
<td style="text-align: left;">Betweenness Centrality</td>
<td style="text-align: left;">Weighted Betweenness Centrality <span class="math inline">\(x'_i = \sum_{st} \frac{n^i_{st}}{g_{st}}T_{st}\)</span></td>
<td style="text-align: left;"><span class="math inline">\(T_{ij}\)</span> as the number of flows from <span class="math inline">\(i\)</span> to <span class="math inline">\(j\)</span>. The betweenness centrality, weighting each origin-destination pair by the number of flows.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Closenese Centrality</td>
<td style="text-align: left;">Harmonic Weighted Closeness Centrality <span class="math inline">\(C''_i = \frac{1}{n-1} \sum_j \frac{1}{u_{ij}}\)</span></td>
<td style="text-align: left;">When considering the inverse of flows as the <strong>social distance</strong> between nodes, <span class="math inline">\(u_{ij}\)</span> is defined as the smallest social distance between nodes <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span>. A harmonic mean was used to account for edges with zero flow (infinite social distance). Simply giving the weight <span class="math inline">\(T_{ij}\)</span> in <a href="#eq-closeness-centrality">Equation&nbsp;3</a> as <span class="math inline">\(C'_i = \frac{\sum_j T_{ij}}{\sum_j T_{ij}d_{ij}}\)</span> gives the average distance travelled by the user of the station, which is difficult to interpret from the perspective of importantness. (<span class="math inline">\(C'_i\)</span> may be larger in the city centre attracting people from longer distances, or at the outskirts where passengers need to travel long distances in general.)</td>
</tr>
</tbody>
</table>
</div>
<p>Comparing the weighted degree and betweenness centralities in <a href="#tbl-weighted-centrality-measures">Table&nbsp;7</a>, their difference lies in whether it counts journeys that originate or terminate at the node in question, and whether it double-counts flows that pass through the node. Thus, their relationship can be expressed as</p>
<p><span id="eq-bet-weighted2"><span class="math display">\[
s_i = 2x'_i + (O_i + D_i - T_{ii})
\tag{4}\]</span></span></p>
<p>where <span class="math inline">\(O_i, D_i\)</span> is the number of flows originating and terminating at node <span class="math inline">\(i\)</span>.</p>
<p>Based on the above measures, we have examined the stations with high weighted centrality measures.</p>
<p>The stations with the highest weighted degree centrality is shown in <a href="#tbl-weighted-degree">Table&nbsp;8</a>.</p>
<div id="tbl-weighted-degree" class="anchored">
<table class="table">
<caption>Table&nbsp;8: Stations with the highest weighted degree centrality.</caption>
<thead>
<tr class="header">
<th style="text-align: right;">Rank</th>
<th style="text-align: left;">Station</th>
<th style="text-align: right;">Weighted Degree (Strength) <span class="math inline">\((\times 10^5)\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">Bank and Monument</td>
<td style="text-align: right;">5.188</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: left;">Oxford Circus</td>
<td style="text-align: right;">4.889</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: left;">King’s Cross St.&nbsp;Pancras</td>
<td style="text-align: right;">4.671</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: left;">Baker Street</td>
<td style="text-align: right;">3.358</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: left;">Waterloo</td>
<td style="text-align: right;">3.344</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: left;">Euston</td>
<td style="text-align: right;">3.164</td>
</tr>
<tr class="odd">
<td style="text-align: right;">7</td>
<td style="text-align: left;">Green Park</td>
<td style="text-align: right;">3.143</td>
</tr>
<tr class="even">
<td style="text-align: right;">8</td>
<td style="text-align: left;">Victoria</td>
<td style="text-align: right;">2.947</td>
</tr>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: left;">Liverpool Street</td>
<td style="text-align: right;">2.770</td>
</tr>
<tr class="even">
<td style="text-align: right;">10</td>
<td style="text-align: left;">Embankment</td>
<td style="text-align: right;">2.539</td>
</tr>
</tbody>
</table>
</div>
<p>6 out of 10 stations in this table also appear in <a href="#tbl-degree">Table&nbsp;1</a>, while terminal stations such as Euston and Victoria are unique to this list.</p>
<p>The <strong>betweenness centrality</strong> considering flows, given <span class="math inline">\(T_{ij}\)</span> as the number of flows from node <span class="math inline">\(i\)</span> to <span class="math inline">\(j\)</span>, can be proposed as follows:</p>
<p><span id="eq-bet-weighted"><span class="math display">\[
x'_i = \sum_{st} \frac{n^i_{st}}{g_{st}}T_{st}
\tag{5}\]</span></span></p>
<p>The stations with the highest weighted betweenness centrality values are calculated as shown in <a href="#tbl-weighted-betweenness">Table&nbsp;9</a>.</p>
<div id="tbl-weighted-betweenness" class="anchored">
<table class="table">
<caption>Table&nbsp;9: Stations with the highest weighted betweenness centrality.</caption>
<thead>
<tr class="header">
<th style="text-align: right;">Rank</th>
<th style="text-align: left;">Station</th>
<th style="text-align: right;">Weighted Betweenness Centrality <span class="math inline">\((\times 10^5)\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">Oxford Circus</td>
<td style="text-align: right;">4.415</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: left;">Bank and Monument</td>
<td style="text-align: right;">4.104</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: left;">King’s Cross St.&nbsp;Pancras</td>
<td style="text-align: right;">4.052</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: left;">Baker Street</td>
<td style="text-align: right;">3.131</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: left;">Green Park</td>
<td style="text-align: right;">2.852</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: left;">Euston</td>
<td style="text-align: right;">2.816</td>
</tr>
<tr class="odd">
<td style="text-align: right;">7</td>
<td style="text-align: left;">Waterloo</td>
<td style="text-align: right;">2.433</td>
</tr>
<tr class="even">
<td style="text-align: right;">8</td>
<td style="text-align: left;">Embankment</td>
<td style="text-align: right;">2.393</td>
</tr>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: left;">Charing Cross</td>
<td style="text-align: right;">2.277</td>
</tr>
<tr class="even">
<td style="text-align: right;">10</td>
<td style="text-align: left;">Victoria</td>
<td style="text-align: right;">2.236</td>
</tr>
</tbody>
</table>
</div>
<p>6 out of 10 stations are also highly ranked in the unweighted measure in <a href="#tbl-betweenness">Table&nbsp;2</a>. Because of the similarity between the weighted degree centrality, 9 out of 10 stations in <a href="#tbl-weighted-betweenness">Table&nbsp;9</a> appear in <a href="#tbl-weighted-degree">Table&nbsp;8</a> as well.</p>
<p>The stations with high harmonic weighted closeness centrality values are shown in <a href="#tbl-weighted-closeness">Table&nbsp;10</a>.</p>
<div id="tbl-weighted-closeness" class="anchored">
<table class="table">
<caption>Table&nbsp;10: Stations with the highest weighted harmonic closeness centrality.</caption>
<thead>
<tr class="header">
<th style="text-align: right;">Rank</th>
<th style="text-align: left;">Station</th>
<th style="text-align: right;">Harmonic Weighted Closeness Centrality</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">Bank and Monument</td>
<td style="text-align: right;">68.816</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: left;">Liverpool Street</td>
<td style="text-align: right;">66.250</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: left;">Stratford</td>
<td style="text-align: right;">65.282</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: left;">Waterloo</td>
<td style="text-align: right;">64.690</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: left;">Green Park</td>
<td style="text-align: right;">63.928</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: left;">King’s Cross St.&nbsp;Pancras</td>
<td style="text-align: right;">63.876</td>
</tr>
<tr class="odd">
<td style="text-align: right;">7</td>
<td style="text-align: left;">Moorgate</td>
<td style="text-align: right;">62.571</td>
</tr>
<tr class="even">
<td style="text-align: right;">8</td>
<td style="text-align: left;">Oxford Circus</td>
<td style="text-align: right;">61.793</td>
</tr>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: left;">Westminster</td>
<td style="text-align: right;">61.636</td>
</tr>
<tr class="even">
<td style="text-align: right;">10</td>
<td style="text-align: left;">Baker Street</td>
<td style="text-align: right;">61.169</td>
</tr>
</tbody>
</table>
</div>
<p>These stations are not geographically concentrated compared to <a href="#tbl-closeness">Table&nbsp;3</a>. Terminal stations with high originating or terminating journeys, or stations connected by high-flowing edges are highly ranked in this measure. King’s Cross St.&nbsp;Pancras and Oxford Circus are the only stations that appear in both <a href="#tbl-closeness">Table&nbsp;3</a> and <a href="#tbl-weighted-closeness">Table&nbsp;10</a>.</p>
</section>
<section id="impact-measures-1" class="level4" data-number="1.2.2">
<h4 data-number="1.2.2" class="anchored" data-anchor-id="impact-measures-1"><span class="header-section-number">1.2.2</span> Impact Measures</h4>
<p>We have considered the need for adjusting the impact measures in <a href="#tbl-delta-performance">Table&nbsp;4</a> for the weighted network. When considering the weight, each measure should be adjusted as summarised in <a href="#tbl-delta-performance-weighted">Table&nbsp;11</a>.</p>
<div id="tbl-delta-performance-weighted" class="anchored">
<table class="table">
<caption>Table&nbsp;11: Adjustments for the impact measures for a weighted network.</caption>
<colgroup>
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 60%">
</colgroup>
<thead>
<tr class="header">
<th>Original Performance Measure</th>
<th>Weighted Equivalent</th>
<th>Explanation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Size of LCC</td>
<td>Ratio of journeys within same connected component <span class="math inline">\(J(G)\)</span></td>
<td>Drawing the principle of LCC by considering whether two nodes are within the same connected component. Weighting this by the flows between each node pair, resulting in measuring the ratio of journeys that can be completed within a connected component. Note that the size of LCC is also valid in a weighted network, although unable to consider flows.</td>
</tr>
<tr class="even">
<td>Network Efficiency</td>
<td>Weighted Network Efficiency <span class="math inline">\(E'(G)\)</span></td>
<td>Each distance between node pairs weighted according to the number of passengers travelling between them, calculating the average inverted distance of journeys.</td>
</tr>
</tbody>
</table>
</div>
<p><span class="math inline">\(J(G)\)</span> and <span class="math inline">\(E'(G)\)</span> are calculated as shown in <a href="#eq-ratio-connected-journeys">Equation&nbsp;6</a> and <a href="#eq-weighted-efficiency">Equation&nbsp;7</a> respectively.</p>
<p><span id="eq-ratio-connected-journeys"><span class="math display">\[
J(G) = \frac{\sum_{i \ne j} (T_{ij} \delta_{ij})}{T} \quad
\left( \delta_{ij} =
\begin{cases}
1 \text{ if nodes } i \text{ and } j \text{ are connected} \\
0 \text{ otherwise}
\end{cases}
\right)
\tag{6}\]</span></span></p>
<p><span id="eq-weighted-efficiency"><span class="math display">\[
E(G) = \frac{1}{T} \sum_{i \ne j} \frac{T_{ij}}{d_{ij}}
\tag{7}\]</span></span></p>
</section>
<section id="node-removal-1" class="level4" data-number="1.2.3">
<h4 data-number="1.2.3" class="anchored" data-anchor-id="node-removal-1"><span class="header-section-number">1.2.3</span> Node Removal</h4>
<p>The best performing methodology in <a href="#sec-weighted">Section&nbsp;1.2</a> was the sequential removal using betweenness centrality. The unweighted and weighted variants removes stations shown in <a href="#tbl-node-removal-betweenness">Table&nbsp;12</a>.</p>
<div id="tbl-node-removal-betweenness" class="anchored">
<table class="table">
<caption>Table&nbsp;12: Stations removed using the highest unweighted and weighted betweenness centrality. Stations for the unweighted centrality is extracted from <a href="#tbl-removed-stations-2">Table&nbsp;6 (b)</a>.</caption>
<thead>
<tr class="header">
<th style="text-align: right;">Rank</th>
<th style="text-align: left;">Unweighted</th>
<th style="text-align: left;">Weighted</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">Bank and Monument</td>
<td style="text-align: left;">Oxford Circus</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: left;">King’s Cross St.&nbsp;Pancras</td>
<td style="text-align: left;">King’s Cross St.&nbsp;Pancras</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: left;">Canada Water</td>
<td style="text-align: left;">Bank and Monument</td>
</tr>
</tbody>
</table>
</div>
<p>The changes in the performance using <span class="math inline">\(J(G), E(G)\)</span> for each strategy are shown in <a href="#fig-weighted-performance">Figure&nbsp;3</a>. Comparing these results, removing stations based on the unweighted measure has the most impact on the network. The weighted efficiency has dropped significantly, indicating journeys are taking longer or disconnected in the nodes-removed network. Thus, the stations that have the most impact on the performance of the network are: Bank and Monument, King’s Cross St.&nbsp;Pancras, and Stratford.</p>
<div id="fig-weighted-performance" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="img/weighted_node_removal_measures.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;3: Change in the performance measures as a result of node removal according to the weighted and unweighted betweenness centrality.</figcaption>
</figure>
</div>
<p>The weighted strategy takes into account the flows of passengers, but did not outperform the unweighted strategy. One possible explanation is due to the characteristics of the stations removed: the weighted strategy removes stations near the city centre with dense networks allowing for minimal diversions, while the unweighted strategy removes the suburban transit hub of Stratford that immediately disconnects branches, highly impacting performance measures. A further investigation is necessary for a more accurate comparison; continuing the removal may give additional insights.</p>
</section>
</section>
</section>
<section id="part-2-spatial-interaction-models" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="part-2-spatial-interaction-models"><span class="header-section-number">2</span> Part 2: Spatial Interaction Models</h2>
<p>In the second part, we have analysed the morning-peak passenger flows of the London Underground, following a brief introduction of the spatial interaction model.</p>
<section id="models-and-calibration" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="models-and-calibration"><span class="header-section-number">2.1</span> Models and Calibration</h3>
<section id="family-of-spatial-interaction-models" class="level4" data-number="2.1.1">
<h4 data-number="2.1.1" class="anchored" data-anchor-id="family-of-spatial-interaction-models"><span class="header-section-number">2.1.1</span> Family of Spatial Interaction Models</h4>
<p>The spatial interaction model predicts the flow between origin and destination from the amount of activity at both ends and the distance between them, drawing an analogy from Newton’s law of gravity <span class="citation" data-cites="waddell2002">(<a href="#ref-waddell2002" role="doc-biblioref">Waddell, 2002</a>)</span>. Spatial interaction models are classified by the constraints cast on them deriving from actual observations; whether the amount of originating and terminating journeys of nodes are preserved.</p>
<p>In this section, the variables will be denoted as follows:</p>
<ul>
<li><span class="math inline">\(T_{ij}\)</span>: estimated flow from station <span class="math inline">\(i\)</span> to <span class="math inline">\(j\)</span></li>
<li><span class="math inline">\(T\)</span>: total flow within a network, thus <span class="math inline">\(T = \sum_{i,j} T_{ij}\)</span></li>
<li><span class="math inline">\(d_{ij}\)</span>: distance between stations <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> - the cost function is a function of <span class="math inline">\(d_{ij}\)</span> hence denoted as <span class="math inline">\(f(d_{ij})\)</span></li>
<li><span class="math inline">\(O_i\)</span>, <span class="math inline">\(D_j\)</span>: activity at the origin and destination that impacts the originating and terminating flows</li>
</ul>
<p>In this model, <span class="math inline">\(O_i\)</span> and <span class="math inline">\(D_j\)</span> are the number of total journeys from / to the node. As we are analysing the data for the morning peak, <span class="math inline">\(O_i\)</span> corresponds to the population that uses the station and <span class="math inline">\(D_j\)</span> to the number of jobs around the node.</p>
<p>The <strong>unconstrained model</strong> only constrains the model with matching the total flows with the observed value, calculated as:</p>
<p><span id="eq-unconst"><span class="math display">\[
T_{ij} = K O^{\alpha}_i D^{\gamma}_j f(c_{ij}) \quad \left (K = \frac{T}{\sum_i \sum_j O^{\alpha}_i D^{\gamma}_j f(d_{ij})} \right)
\tag{8}\]</span></span></p>
<p><span class="math inline">\(K\)</span> is determined so that the total flow <span class="math inline">\(T\)</span> is preserved. The unconstrained model is used when there is information on the total amount of journeys but no detailed information is available.</p>
<p>The <strong>singly constrained model</strong> constrains the total number of observations for each component at the origin or the destination. The <strong>origin constrained model</strong>, shown in <a href="#eq-orig">Equation&nbsp;9</a>, is a singly constrained model that fixes the total number of journeys at the origin.</p>
<p><span id="eq-orig"><span class="math display">\[
T_{ij} = A_i O_i D^{\gamma}_j f(d_{ij})
\tag{9}\]</span></span></p>
<p>The parameter <span class="math inline">\(A_i\)</span> is determined so that the total at the origin is constrained.</p>
<p><span id="eq-orig-ai"><span class="math display">\[
\sum_j T_{ij} = O_i \therefore A_i = \frac{1}{\sum_j D^{\gamma}_j f(d_{ij})}
\tag{10}\]</span></span></p>
<p>This model is widely used for flow prediction in various use-cases, including deciding the location and size for retail developments based on the residential distribution within a certain area <span class="citation" data-cites="haynes2020">(<a href="#ref-haynes2020" role="doc-biblioref">Haynes and Fotheringham, 2020</a>)</span>.</p>
<p>Similarly, the <strong>destination constrained model</strong> constrains the total at the destination, where the flows are calculated by <a href="#eq-dest">Equation&nbsp;11</a>.</p>
<p><span id="eq-dest"><span class="math display">\[
T_{ij} = O^{\alpha}_i B_j D_j f(c_{ij}) \quad
\text{where } \left (B_j = \frac{1}{\sum_i O^{\alpha}_i f(c_{ij})} \right)
\tag{11}\]</span></span></p>
<p>This can be used for predicting flows from origins given a particular destination, such as estimating the impact of a new development within a city <span class="citation" data-cites="haynes2020">(<a href="#ref-haynes2020" role="doc-biblioref">Haynes and Fotheringham, 2020</a>)</span>.</p>
<p>The <strong>doubly constrained model</strong> constrains both the total at the origin and destination.</p>
<p><span id="eq-dbl"><span class="math display">\[
T_{ij} = A_i O_i B_j D_j \exp(-\beta d_{ij})
\tag{12}\]</span></span></p>
<p>This is used in the transport planning context as a method of trip distribution in the 4-step method, estimating flows based on activity of both ends <span class="citation" data-cites="robinson2011">(<a href="#ref-robinson2011" role="doc-biblioref">Robinson, 2011</a>)</span>.</p>
</section>
<section id="calibration-of-parameters" class="level4" data-number="2.1.2">
<h4 data-number="2.1.2" class="anchored" data-anchor-id="calibration-of-parameters"><span class="header-section-number">2.1.2</span> Calibration of Parameters</h4>
<p>In this report, an origin-constrained model is used to simulate the different scenarios. This is justified in <a href="#sec-scenarios">Section&nbsp;2.2</a>. The dataset used for analysis have the following data for every London Underground Station.</p>
<ul>
<li>population of origin</li>
<li>jobs at the destination</li>
<li>distance between origin and destination</li>
<li>flow from the origin to the destination</li>
</ul>
<p>For the calibration process, we will first use the doubly constrained model to estimate the best cost function and parameters by comparing with the observed flow. Then, the origin-constrained model required for the scenarios are used to calibrate the <span class="math inline">\(\gamma\)</span> parameter. For the cost function, constraining both the total journeys for both the origin and destination will enable the full utilisation of observed data, enabling the most accurate calibration. The <span class="math inline">\(\gamma\)</span> parameter does not appear in the doubly constrained model, and is required to calibrate in the origin-constrained model.</p>
<section id="calibration-of-the-cost-function" class="level5 unnumbered">
<h5 class="unnumbered anchored" data-anchor-id="calibration-of-the-cost-function">Calibration of the cost function</h5>
<p>The Poisson model <span class="citation" data-cites="flowerdew1982">(<a href="#ref-flowerdew1982" role="doc-biblioref">Flowerdew and Aitkin, 1982</a>)</span> of the doubly constrained model <a href="#eq-dbl">Equation&nbsp;12</a> is written as:</p>
<p><span class="math display">\[
\ln(T_{ij}) = \ln A_i + \ln O_i + \ln B_j + \ln D_j + \ln f(d_{ij}) \\
\]</span></p>
<p>For the cost function <span class="math inline">\(f(d_{ij})\)</span>, the negative exponential and inverse power functions are compared (<a href="#eq-cost-function">Equation&nbsp;13</a>) to determine the better performing relationship and the optimal parameter <span class="math inline">\(\beta\)</span>. The results are shown in <a href="#tbl-beta">Table&nbsp;13</a>.</p>
<p><span id="eq-cost-function"><span class="math display">\[
f(d_{ij}) =
\begin{cases}
\exp(-\beta d_{ij}) \text{ (Negative Exponential)} \\
d^{-\beta}_{ij}  \text{ (Inverse Power)}
\end{cases}
\tag{13}\]</span></span></p>
<div id="tbl-beta" class="anchored">
<table class="table">
<caption>Table&nbsp;13: Comparison of results for the doubly constrained model using inverse power and negative exponential cost functions.</caption>
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th>Cost Function</th>
<th>Parameter <span class="math inline">\(\beta\)</span></th>
<th><span class="math inline">\(R^2\)</span> value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Negative exponential <span class="math inline">\(f(d_{ij}) = \exp(-\beta d_{ij})\)</span></td>
<td><span class="math inline">\(\beta = 1.543 \times 10^{-4}\)</span></td>
<td><span class="math inline">\(R^2 = 0.4979\)</span></td>
</tr>
<tr class="even">
<td>Inverse Power <span class="math inline">\(f(d_{ij}) = d^{-\beta}_{ij}\)</span></td>
<td><span class="math inline">\(\beta = 9.096 \times 10^{-1}\)</span></td>
<td><span class="math inline">\(R^2 = 0.4077\)</span></td>
</tr>
</tbody>
</table>
</div>
<p>Since the negative exponential model (<a href="#eq-beta">Equation&nbsp;14</a>) has a better fit to the observed flows, this is used in the rest of the analysis.</p>
<p><span id="eq-beta"><span class="math display">\[
f(d_{ij}) = \exp(-\beta d_{ij}) \quad (\beta = -1.543 \times 10^{-4})
\tag{14}\]</span></span></p>
</section>
<section id="calibration-of-gamma" class="level5 unnumbered">
<h5 class="unnumbered anchored" data-anchor-id="calibration-of-gamma">Calibration of <span class="math inline">\(\gamma\)</span></h5>
<p>Since the origin-constrained model was used for the analysis of the scenarios, the gamma variable must be calibrated before applying to the new scenarios. <a href="#eq-orig">Equation&nbsp;9</a> is transformed into a Poisson Model as follows:</p>
<p><span id="eq-orig-poisson"><span class="math display">\[
\ln(T_{ij}) = \ln A_i + \ln O_i + \gamma \ln D_j + \ln f(d_{ij}) \\
\tag{15}\]</span></span></p>
<p><span class="math inline">\(\gamma\)</span> with the highest R-squared value was used, resulting as follows:</p>
<p><span id="eq-gamma"><span class="math display">\[
\gamma = 7.556 \times 10^{-1} \quad (R^2 = 0.4680)
\tag{16}\]</span></span></p>
</section>
</section>
</section>
<section id="sec-scenarios" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="sec-scenarios"><span class="header-section-number">2.2</span> Scenarios</h3>
<p>The scenarios we have considered are summarised in <a href="#tbl-scenarios">Table&nbsp;14</a>.</p>
<div id="tbl-scenarios" class="anchored">
<table class="table">
<caption>Table&nbsp;14: The scenarios explored in this report</caption>
<colgroup>
<col style="width: 20%">
<col style="width: 80%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Scenario</th>
<th style="text-align: left;">Explanation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Scenario A</td>
<td style="text-align: left;">Jobs at Canary Wharf decrease by 50 %</td>
</tr>
<tr class="even">
<td style="text-align: left;">Scenario B</td>
<td style="text-align: left;">Increase in cost of transport - considering 2 parameters</td>
</tr>
</tbody>
</table>
</div>
<p>Since scenario A involves the change in the characteristics of the destination, the origin constrained model is used for the analysis to preserve the number of commuters starting their journeys in each area. The same model was used for scenario B and the original state for a fair comparison between scenarios.</p>
<section id="scenario-a" class="level4" data-number="2.2.1">
<h4 data-number="2.2.1" class="anchored" data-anchor-id="scenario-a"><span class="header-section-number">2.2.1</span> Scenario A</h4>
<p>We have first decreased the number of jobs at Canary Wharf by 50% from <span class="math inline">\(D_j\)</span> to <span class="math inline">\(D'_j\)</span> (<a href="#eq-halfdj">Equation&nbsp;17</a>). We have observed how the destination of commuters changed in reaction to this decrease using the origin-constrained model (<a href="#eq-orig-poisson">Equation&nbsp;15</a>).</p>
<p><span id="eq-halfdj"><span class="math display">\[
D'_j = \frac{D_j}{2}
\tag{17}\]</span></span></p>
<p><span class="math inline">\(A_i\)</span> needs to be adjusted so that the new parameter <span class="math inline">\(A'_i\)</span> fulfills <a href="#eq-orig-ai-adj">Equation&nbsp;18</a>, ensuring the total flows that originate from each station is conserved.</p>
<p><span id="eq-orig-ai-adj"><span class="math display">\[
A'_i = \frac{1}{\sum_j D'^{\gamma}_j f(d_{ij})}
\tag{18}\]</span></span></p>
<p>Finally, the new flows <span class="math inline">\(T'_{ij}\)</span> is estimated as shown below, derived from <a href="#eq-orig">Equation&nbsp;9</a>.</p>
<p><span class="math display">\[
T'_{ij} = A'_i O_i D'^{\gamma}_j \exp(-\beta d_{ij})
\]</span></p>
<p>As a result, a significant drop in the number of journeys terminating at Canary Wharf was observed, from 47,690 in total to 29,496 (61.9 % of original flow). As observable from <a href="#fig-OD-scenarioA">Figure&nbsp;4</a>, the decrease in the flows to Canary Wharf occured evenly among all origins, and were redistributed into other destinations.</p>
<div id="fig-OD-scenarioA" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="img/OD_change_scenarioA.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;4: Comparison of the flows of OD pairs the original simulation and the flows under scenario A.</figcaption>
</figure>
</div>
</section>
<section id="scenario-b" class="level4" data-number="2.2.2">
<h4 data-number="2.2.2" class="anchored" data-anchor-id="scenario-b"><span class="header-section-number">2.2.2</span> Scenario B</h4>
<p>We have considered the increase of cost in this scenario, using two scenarios B1 and B2 each modifying the cost functions <span class="math inline">\(\beta_1, \beta_2\)</span> as shown in <a href="#eq-paramsB">Equation&nbsp;19</a> and illstrated in <a href="#fig-paramsB">Figure&nbsp;5</a>.</p>
<p><span id="eq-paramsB"><span class="math display">\[
\begin{cases}
\beta_1 = 2 \beta \\
\beta_2 = 10 \beta
\end{cases}
\quad (\beta = -1.543 \times 10^{-4})
\tag{19}\]</span></span></p>
<div id="fig-paramsB" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="img/dist_decay.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;5: Distance decay function for the original and modified scenarios. The cost is equivalent to travelling twice (B1) or 10 times (B2) the distance in the original model.</figcaption>
</figure>
</div>
<p>The new flows for this scenario was calcuated following the same parameter-recalibration process in scenario A. The flows between origin-destination pairs plotted by distance of journeys are shown in <a href="#fig-OD-scenarioB">Figure&nbsp;6</a>. As the <span class="math inline">\(\beta\)</span> increases, the longer distance journeys have lower frequency compared to the original scenario.</p>
<div id="fig-OD-scenarioB" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="img/OD_change_scenarioB.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;6: Comparison of the relationship between the distance and the number of flows for scenario B and the original model. Raising the cost function results in a negatively skewed distance distribution.</figcaption>
</figure>
</div>
</section>
<section id="discussion" class="level4" data-number="2.2.3">
<h4 data-number="2.2.3" class="anchored" data-anchor-id="discussion"><span class="header-section-number">2.2.3</span> Discussion</h4>
<p>In order to examine flow change and to compare between scenarios, measurements in <a href="#tbl-measurements">Table&nbsp;15</a> were calculated.</p>
<div id="tbl-measurements" class="anchored">
<table class="table">
<caption>Table&nbsp;15: Measurements considered to quantify the change in flows for each scenario.</caption>
<colgroup>
<col style="width: 30%">
<col style="width: 70%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Measurement</th>
<th style="text-align: left;">Explanation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Quantity of change in destination <span class="math inline">\(T_{\text{diff}} = \frac{\sum_{i,j} |T'_{ij} - T_{ij}|}{2}\)</span></td>
<td style="text-align: left;">The number of flows that have different destinations than the original scenario. (<span class="math inline">\(T'_{ij}\)</span> is the number of journeys from station <span class="math inline">\(i\)</span> to <span class="math inline">\(j\)</span> under the scenario.) A larger change in destinations indicate larger impact on the movement of people within the underground network.</td>
</tr>
<tr class="even">
<td style="text-align: left;">Mean distance of journeys <span class="math inline">\(\bar{\delta} = \frac{\sum_{i,j}\left(T_{ij}d_{ij}\right)}{T}\)</span></td>
<td style="text-align: left;">The mean distance of all journeys simulated in each scenario. A larger change in the distance compared to the original simulation indicate larger impact.</td>
</tr>
</tbody>
</table>
</div>
<p>For each scenario, values for these measurements are calculated as shown in <a href="#tbl-measure-scenarios">Table&nbsp;16</a>.</p>
<div id="tbl-measure-scenarios" class="anchored">
<table class="table">
<caption>Table&nbsp;16: Impact measurements for each scenario.</caption>
<colgroup>
<col style="width: 30%">
<col style="width: 20%">
<col style="width: 35%">
<col style="width: 15%">
</colgroup>
<thead>
<tr class="header">
<th>Scenario</th>
<th style="text-align: right;"><span class="math inline">\(T_{\text{diff}}\)</span></th>
<th style="text-align: right;"><span class="math inline">\(T_{\text{diff}} / T\)</span> [%]</th>
<th style="text-align: right;"><span class="math inline">\(\bar{\delta}\)</span> [m]</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><em>Original Simulation</em></td>
<td style="text-align: right;">-</td>
<td style="text-align: right;"><em>(Total flows: 1,542,283)</em></td>
<td style="text-align: right;"><em>8,583</em></td>
</tr>
<tr class="even">
<td>Scenario A</td>
<td style="text-align: right;">18,193</td>
<td style="text-align: right;">1.2 % of total flows</td>
<td style="text-align: right;">8,579</td>
</tr>
<tr class="odd">
<td>Scenario B1</td>
<td style="text-align: right;">346,503</td>
<td style="text-align: right;">22.47 % of total flows</td>
<td style="text-align: right;">6,030</td>
</tr>
<tr class="even">
<td>Scenario B2</td>
<td style="text-align: right;">1,222,191</td>
<td style="text-align: right;">79.25 % of total flows</td>
<td style="text-align: right;">1,613</td>
</tr>
</tbody>
</table>
</div>
<p><span class="math inline">\(T_{\text{diff}}\)</span> and <span class="math inline">\(\bar{\delta}\)</span> both indicate that scenario B2 had the largest impact on the number of flows, and scenario A the least impactful.</p>
<p>The intervention to the travel cost (scenario B) directly impacts all origin-destination pairs, while the reduction of jobs in one area (scenario A) only impacts journeys that end at the station affected. This different nature of the interventions dictate the magnitude of change it causes; thus scenario B has a larger impact on the flows on the network as a whole.</p>
<p>Recalling the impact of scenario A on Canary Wharf was a 39 % decrease in the total inflows, which falls between scenarios B1 and B2 in terms of <span class="math inline">\(T_{\text{diff}}\)</span>. Even focusing on one station, it is rational to conclude scenario B2 has the largest impact.</p>
<p>In conclusion, a drastic impact on the cost function has more impact throughout the network compared to a large change in the demand in a particular area. Further analysis can be done using the actual changes in the underground fares as a natural experiment, comparing with predicted results in a replicated scenario.</p>
<hr>
<p>Word count: 2,994 words</p>
<p>GitHub repository (as hyperlink): <a href="https://github.com/sokimura39/Urban_Simulation_Report">Urban_Simulation_Report</a></p>
<div style="page-break-after: always;"></div>
</section>
</section>
</section>
<section id="references" class="level2 unnumbered">


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body" role="list">
<div id="ref-achard2007" class="csl-entry" role="listitem">
Achard, S. and Bullmore, E. (2007) <span>“Efficiency and <span>Cost</span> of <span>Economical Brain Functional Networks</span>,”</span> <em>PLOS Computational Biology</em>, 3(2), p. e17. doi: <a href="https://doi.org/10.1371/journal.pcbi.0030017">10.1371/journal.pcbi.0030017</a>.
</div>
<div id="ref-broder2000" class="csl-entry" role="listitem">
Broder, A. <em>et al.</em> (2000) <span>“Graph structure in the <span>Web</span>,”</span> <em>Computer Networks</em>, 33(1), pp. 309–320. doi: <a href="https://doi.org/10.1016/S1389-1286(00)00083-9">10.1016/S1389-1286(00)00083-9</a>.
</div>
<div id="ref-flowerdew1982" class="csl-entry" role="listitem">
Flowerdew, R. and Aitkin, M. (1982) <span>“A <span>Method</span> of <span>Fitting</span> the <span>Gravity Model Based</span> on the <span>Poisson Distribution</span>*,”</span> <em>Journal of Regional Science</em>, 22(2), pp. 191–202. doi: <a href="https://doi.org/10.1111/j.1467-9787.1982.tb00744.x">10.1111/j.1467-9787.1982.tb00744.x</a>.
</div>
<div id="ref-haynes2020" class="csl-entry" role="listitem">
Haynes, K. and Fotheringham, A. (2020) <span>“Gravity and <span>Spatial Interaction Models</span>,”</span> <em>1985</em>.
</div>
<div id="ref-latora2001" class="csl-entry" role="listitem">
Latora, V. and Marchiori, M. (2001) <span>“Efficient <span>Behavior</span> of <span>Small-World Networks</span>,”</span> <em>Physical Review Letters</em>, 87(19), p. 198701. doi: <a href="https://doi.org/10.1103/PhysRevLett.87.198701">10.1103/PhysRevLett.87.198701</a>.
</div>
<div id="ref-latora2007" class="csl-entry" role="listitem">
Latora, V. and Marchiori, M. (2007) <span>“A measure of centrality based on network efficiency,”</span> <em>New Journal of Physics</em>, 9(6), p. 188. doi: <a href="https://doi.org/10.1088/1367-2630/9/6/188">10.1088/1367-2630/9/6/188</a>.
</div>
<div id="ref-leatherdale2016" class="csl-entry" role="listitem">
Leatherdale, D. (2016) <span>“Are we nearly there yet? <span>Finding</span> out where ’there’ is,”</span> <em>BBC News</em>.
</div>
<div id="ref-lee2008" class="csl-entry" role="listitem">
Lee, K. <em>et al.</em> (2008) <span>“Statistical analysis of the <span>Metropolitan Seoul Subway System</span>: <span>Network</span> structure and passenger flows,”</span> <em>Physica A: Statistical Mechanics and its Applications</em>, 387(24), pp. 6231–6234. doi: <a href="https://doi.org/10.1016/j.physa.2008.06.035">10.1016/j.physa.2008.06.035</a>.
</div>
<div id="ref-paaswell2012" class="csl-entry" role="listitem">
Paaswell, R. E. (2012) <span>“Approaches to <span>Infrastructure Redevelopment</span>, <span>WTC</span>, <span>Lower NYC</span> and the <span>Region</span>,”</span> pp. 215–226. doi: <a href="https://doi.org/10.1061/40717(148)18">10.1061/40717(148)18</a>.
</div>
<div id="ref-robinson2011" class="csl-entry" role="listitem">
Robinson, D. (ed.) (2011) <em>Computer <span>Modelling</span> for <span>Sustainable Urban Design</span>: <span>Physical Principles</span>, <span>Methods</span> and <span>Applications</span></em>. London: Routledge. doi: <a href="https://doi.org/10.4324/9781849775403">10.4324/9781849775403</a>.
</div>
<div id="ref-transportforlondon2021" class="csl-entry" role="listitem">
Transport for London (2021) <span>“Project <span>NUMBAT</span>.”</span>
</div>
<div id="ref-waddell2002" class="csl-entry" role="listitem">
Waddell, P. (2002) <span>“<span>UrbanSim</span>: <span>Modeling Urban Development</span> for <span>Land Use</span>, <span>Transportation</span>, and <span>Environmental Planning</span>,”</span> <em>Journal of the American Planning Association</em>, 68(3), pp. 297–314. doi: <a href="https://doi.org/10.1080/01944360208976274">10.1080/01944360208976274</a>.
</div>
<div id="ref-wasserman1994" class="csl-entry" role="listitem">
Wasserman, S. and Faust, K. (1994) <em>Social <span>Network Analysis</span>: <span>Methods</span> and <span>Applications</span></em>. Cambridge University Press.
</div>
<div id="ref-wyatt2002" class="csl-entry" role="listitem">
Wyatt, E. (2002) <span>“Subway <span>Service</span> to <span>Resume On Routes Closed After</span> 9/11,”</span> <em>The New York Times</em>.
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>